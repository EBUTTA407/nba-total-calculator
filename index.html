<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NBA Live Total Calculator</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121b2f; --muted:#9fb0d0; --text:#eaf0ff; --accent:#6aa9ff;
      --good:#3ddc97; --warn:#ffcc66; --bad:#ff6b6b;
      --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#070b14,#0b1220 35%,#070b14);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    .top{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:20px;margin:0 0 2px 0;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px;margin:0}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;margin-top:14px}
    @media(max-width:920px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(18,27,47,.85);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 10px 26px rgba(0,0,0,.25)}
    .card h2{font-size:14px;margin:0 0 10px 0;color:#d9e5ff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:520px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input,select{width:100%;padding:10px 11px;border-radius:12px;background:#0a1020;border:1px solid var(--border);color:var(--text);outline:none}
    input:focus,select:focus{border-color:rgba(106,169,255,.6);box-shadow:0 0 0 3px rgba(106,169,255,.18)}
    .tog{display:flex;align-items:center;gap:10px;padding:10px 11px;border-radius:12px;background:#0a1020;border:1px solid var(--border)}
    .tog input{width:18px;height:18px}
    .tog span{font-size:13px;color:#dce7ff}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{cursor:pointer;border:1px solid var(--border);background:linear-gradient(180deg,rgba(106,169,255,.22),rgba(106,169,255,.08));color:var(--text);padding:10px 12px;border-radius:12px;font-weight:650}
    button:hover{border-color:rgba(106,169,255,.55)}
    button.secondary{background:rgba(255,255,255,.04)}
    button.danger{background:linear-gradient(180deg,rgba(255,107,107,.22),rgba(255,107,107,.08))}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
    .pill b{color:var(--text)}
    .out{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:620px){.out{grid-template-columns:1fr}}
    .metric{padding:12px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.03)}
    .metric .k{font-size:11px;color:var(--muted)}
    .metric .v{font-size:20px;font-weight:780;margin-top:4px}
    .metric .s{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.25}
    .lean{padding:14px;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.03)}
    .lean .big{font-size:22px;font-weight:900;letter-spacing:.3px}
    .lean.good{border-color:rgba(61,220,151,.35);box-shadow:0 0 0 3px rgba(61,220,151,.12) inset}
    .lean.warn{border-color:rgba(255,204,102,.35);box-shadow:0 0 0 3px rgba(255,204,102,.12) inset}
    .lean.bad{border-color:rgba(255,107,107,.35);box-shadow:0 0 0 3px rgba(255,107,107,.12) inset}
    .flags{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .flag{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border);background:rgba(255,255,255,.03)}
    .flag.good{border-color:rgba(61,220,151,.35); color:var(--good)}
    .flag.warn{border-color:rgba(255,204,102,.35); color:var(--warn)}
    .flag.bad{border-color:rgba(255,107,107,.35); color:var(--bad)}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px 6px;font-size:12px;text-align:left;color:var(--muted)}
    th{color:#d9e5ff;font-weight:700}
    .right{text-align:right}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:820px){.two{grid-template-columns:1fr}}
    a{color:var(--accent);text-decoration:none;font-weight:700}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>NBA Live Total Points Calculator</h1>
        <p class="sub">
          Auto-fill: OddsAPI totals + ESPN scoreboard/boxscore.
          • <a href="nba_total_calc.py" download>Download terminal script (Python)</a>
        </p>
      </div>
      <div class="pill"><b id="stamp">—</b></div>
    </div>

    <div class="grid">
      <!-- INPUTS -->
      <div class="card">
        <h2>Live Inputs</h2>

        <div class="row">
          <div>
            <label>Quarter</label>
            <select id="q">
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div>
            <label>Time left in quarter (mm:ss)</label>
            <input id="tleft" value="12:00" placeholder="7:10" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Home points</label>
            <input id="homePts" type="number" step="1" value="0" />
          </div>
          <div>
            <label>Away points</label>
            <input id="awayPts" type="number" step="1" value="0" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Computed total (auto)</label>
            <input id="pts" type="number" step="1" value="0" disabled />
          </div>
          <div>
            <label>Current market total</label>
            <input id="live" type="number" step="0.5" value="0" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Home live team total (optional)</label>
            <input id="homeLine" type="number" step="0.5" placeholder="optional" />
          </div>
          <div>
            <label>Away live team total (optional)</label>
            <input id="awayLine" type="number" step="0.5" placeholder="optional" />
          </div>
        </div>

        <div class="hr"></div>
        <h2>Auto-Fill (OddsAPI + ESPN)</h2>

        <div class="row">
          <div>
            <label>Worker URL (Cloudflare)</label>
            <input id="apiBase" value="https://nba-total-autofill-proxy.ebuttta407.workers.dev" />
          </div>
          <div>
            <label>Game</label>
            <select id="gameSel"></select>
          </div>
        </div>

        <div class="btns" style="margin-top:10px">
          <button id="apiRefresh" class="secondary">Refresh games</button>
          <button id="apiFillAll" class="secondary">Fill totals + baseline + (live score/clock)</button>
          <button id="apiStats" class="secondary">Fetch 3P% + FTA</button>
        </div>

        <p class="small" style="margin-top:8px">
          Pregame: Fill sets Market total AND Baseline total to match. Live: Fill also sets score + quarter + clock.
        </p>

        <div class="hr"></div>

        <div class="row">
          <div>
            <label>Pregame total (baseline)</label>
            <input id="line" type="number" step="0.5" value="0" />
          </div>
          <div>
            <label>Edge threshold (pts) for bet lean</label>
            <input id="thr" type="number" step="0.5" value="4" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Alpha (trust live pace) — auto if blank</label>
            <input id="alpha" type="number" step="0.05" placeholder="auto" />
          </div>
          <div>
            <label>Bonus/FT boost (pts per minute) if in bonus</label>
            <input id="bonusBoost" type="number" step="0.05" value="0.25" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="tog">
            <input id="bonus" type="checkbox" />
            <span>Both teams in bonus / frequent whistles right now</span>
          </div>
          <div class="tog">
            <input id="ftparade" type="checkbox" />
            <span>FT parade (intentional fouls / nonstop FTs)</span>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>FTA so far (both teams) — optional</label>
            <input id="fta" type="number" step="1" placeholder="optional" />
          </div>
          <div>
            <label>3P% so far (combined, 0–1) — optional</label>
            <input id="tpct" type="number" step="0.01" placeholder="e.g., 0.42" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="btns">
          <button id="calc">Calculate</button>
          <button id="reset" class="danger">Reset</button>
        </div>
      </div>

      <!-- OUTPUTS -->
      <div class="card">
        <h2>Outputs</h2>

        <div class="out">
          <div class="metric">
            <div class="k">Elapsed minutes</div>
            <div class="v mono" id="elapsed">—</div>
            <div class="s" id="alphaUsed">Alpha: —</div>
          </div>
          <div class="metric">
            <div class="k">Current pace (pts/min)</div>
            <div class="v mono" id="ppm">—</div>
            <div class="s" id="needppm">Needed for market: —</div>
          </div>
          <div class="metric">
            <div class="k">Pace projection (no reversion)</div>
            <div class="v mono" id="paceProj">—</div>
            <div class="s">Pure pace extrapolation.</div>
          </div>
          <div class="metric">
            <div class="k">Blended projection (recommended)</div>
            <div class="v mono" id="blendProj">—</div>
            <div class="s" id="edge">Edge vs market: —</div>
          </div>
        </div>

        <div style="margin-top:10px" id="leanBox" class="lean warn">
          <div class="big" id="lean">—</div>
          <div class="small" id="why">—</div>
          <div class="flags" id="flags"></div>
        </div>

        <div class="hr"></div>

        <!-- ✅ HEDGE IS HERE -->
        <h2>Hedge Calculator (Totals)</h2>
        <div class="two">
          <div>
            <div class="row">
              <div>
                <label>My bet side</label>
                <select id="mySide">
                  <option value="UNDER" selected>UNDER</option>
                  <option value="OVER">OVER</option>
                </select>
              </div>
              <div>
                <label>My bet line</label>
                <input id="myLine" type="number" step="0.5" value="228.5" />
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <div>
                <label>My stake ($)</label>
                <input id="myStake" type="number" step="1" value="100" />
              </div>
              <div>
                <label>My odds (American)</label>
                <input id="myOdds" type="number" step="1" value="-110" />
              </div>
            </div>
          </div>

          <div>
            <div class="row">
              <div>
                <label>Hedge line (defaults to live total)</label>
                <input id="hedgeLine" type="number" step="0.5" placeholder="auto" />
              </div>
              <div>
                <label>Hedge odds (American)</label>
                <input id="hedgeOdds" type="number" step="1" value="-110" />
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <div>
                <label>Hedge suggestion</label>
                <input id="hedgeNow" disabled />
              </div>
              <div>
                <label>Recommended hedge stake ($)</label>
                <input id="hedgeStake" disabled />
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="small" id="hedgeExplain">Enter your ticket info to see an equalized hedge stake + middle range (if applicable).</div>
        <!-- ✅ END HEDGE -->

      </div>
    </div>

    <p class="small" style="margin-top:14px">
      Disclaimer: Math/pace decision support only; doesn’t know injuries/rotations/true market depth. Use responsibly.
    </p>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));

  function nowStamp(){
    const d = new Date();
    return d.toLocaleString(undefined,{hour:'2-digit',minute:'2-digit',second:'2-digit',year:'numeric',month:'short',day:'2-digit'});
  }

  function parseMMSS(s){
    if(!s) return NaN;
    const m = String(s).trim().split(':');
    if(m.length!==2) return NaN;
    const mm = Number(m[0]);
    const ss = Number(m[1]);
    if(!Number.isFinite(mm) || !Number.isFinite(ss)) return NaN;
    return mm + ss/60;
  }

  function decFromAmerican(am){
    const a = Number(am);
    if(!Number.isFinite(a) || a === 0) return NaN;
    if(a < 0) return 1 + (100/Math.abs(a));
    return 1 + (a/100);
  }

  function autoAlpha(elapsed){
    return clamp(0.35 + 0.012*elapsed, 0.35, 0.90);
  }

  function fmt(x, d=1){
    if(!Number.isFinite(x)) return '—';
    return x.toFixed(d);
  }

  function optNum(id){
    const v = $(id).value;
    const s = (v === null || v === undefined) ? '' : String(v).trim();
    if(s === '') return NaN;
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  async function apiGet(path){
    const base = $('apiBase').value.trim().replace(/\/+$/,'');
    if(!base) throw new Error("Worker URL is blank.");
    const r = await fetch(base + path);
    const txt = await r.text();
    if(!r.ok) throw new Error(txt);
    return JSON.parse(txt);
  }

  let lastApi = null;

  function populateGames(games){
    const sel = $('gameSel');
    sel.innerHTML = '';
    for(const g of (games || [])){
      const total = Number.isFinite(g.totals_consensus) ? `Tot ${g.totals_consensus}` : '';
      const opt = document.createElement('option');
      opt.value = g.id;
      opt.textContent = `${g.away_team} @ ${g.home_team}  ${total}`.trim();
      sel.appendChild(opt);
    }
  }

  function hedgeCalc(){
    const liveTotal = Number($('live').value);

    const mySide = $('mySide').value.toUpperCase();
    const myLine = Number($('myLine').value);
    const myStake = Number($('myStake').value);
    const myOdds = Number($('myOdds').value);

    let hLine = Number($('hedgeLine').value);
    if(!Number.isFinite(hLine)) hLine = liveTotal;

    const hOdds = Number($('hedgeOdds').value);

    const dec0 = decFromAmerican(myOdds);
    const decH = decFromAmerican(hOdds);

    let suggestion = '—';
    let hStake = NaN;
    let explain = '';

    const clv = (mySide === 'UNDER') ? (myLine - liveTotal) : (liveTotal - myLine);

    if(Number.isFinite(clv) && clv >= 6) suggestion = 'Hold (good CLV)';
    else if(Number.isFinite(clv) && clv >= 3) suggestion = 'Watch closely';
    else suggestion = 'No hedge signal';

    if(Number.isFinite(dec0) && Number.isFinite(decH) && Number.isFinite(myStake) && myStake>0){
      hStake = myStake * dec0 / decH;

      let middle = '';
      if(mySide === 'UNDER'){
        middle = (Number.isFinite(myLine) && Number.isFinite(hLine) && hLine < myLine)
          ? `Middle range: ${fmt(hLine,1)} to ${fmt(myLine,1)}`
          : `No classic middle.`;
      } else {
        middle = (Number.isFinite(myLine) && Number.isFinite(hLine) && hLine > myLine)
          ? `Middle range: ${fmt(myLine,1)} to ${fmt(hLine,1)}`
          : `No classic middle.`;
      }

      const win0 = myStake*(dec0-1);
      const lose0 = -myStake;
      const winH = hStake*(decH-1);
      const loseH = -hStake;

      const worst = Math.min(win0 + loseH, lose0 + winH);
      const best = win0 + winH;

      explain = `Equalized hedge stake ≈ $${fmt(hStake,2)} at ${fmt(hLine,1)}. ${middle}. Worst-case ≈ $${fmt(worst,2)}; best-case ≈ $${fmt(best,2)}.`;
    } else {
      explain = 'Enter valid stake and odds to compute hedge sizing.';
    }

    $('hedgeNow').value = suggestion;
    $('hedgeStake').value = Number.isFinite(hStake) ? fmt(hStake,2) : '—';
    $('hedgeExplain').textContent = explain;
  }

  function compute(){
    const q = Number($('q').value);
    const tleft = $('tleft').value;

    const homePts = Number($('homePts').value);
    const awayPts = Number($('awayPts').value);
    const pts = homePts + awayPts;
    $('pts').value = Number.isFinite(pts) ? String(pts) : '';

    const live = Number($('live').value);
    const line = Number($('line').value);
    const thr = Number($('thr').value);

    const tleftMin = parseMMSS(tleft);
    const elapsed = (q-1)*12 + (12 - tleftMin);

    const valid = (Number.isFinite(elapsed) && elapsed > 0 && elapsed <= 48 &&
                  Number.isFinite(homePts) && homePts >= 0 &&
                  Number.isFinite(awayPts) && awayPts >= 0);

    let alpha = optNum('alpha');
    const alphaIsManual = Number.isFinite(alpha);
    if(!alphaIsManual) alpha = autoAlpha(elapsed);
    alpha = clamp(alpha, 0.05, 0.95);

    const bonus = $('bonus').checked;
    const ftparade = $('ftparade').checked;
    const bonusBoost = Number.isFinite(optNum('bonusBoost')) ? optNum('bonusBoost') : 0.25;
    const boost = (bonus ? bonusBoost : 0) + (ftparade ? 0.35 : 0);

    const ppm = valid ? pts/elapsed : NaN;
    const paceProj = valid ? ppm*48 : NaN;

    const baselineRate = (Number.isFinite(line) && line>0) ? line/48 : NaN;
    const blendedRate = (Number.isFinite(baselineRate) && valid) ? (alpha*(ppm + boost) + (1-alpha)*baselineRate) : NaN;
    const blendProj = (Number.isFinite(blendedRate) && valid) ? (pts + blendedRate*(48 - elapsed)) : NaN;

    const edge = (Number.isFinite(blendProj) && Number.isFinite(live)) ? (blendProj - live) : NaN;
    const needPPM = (Number.isFinite(live) && valid) ? ((live - pts) / (48 - elapsed)) : NaN;

    $('stamp').textContent = nowStamp();
    $('elapsed').textContent = valid ? `${fmt(elapsed,2)} min` : '—';
    $('alphaUsed').textContent = `Alpha used: ${fmt(alpha,2)}${alphaIsManual ? ' (manual)' : ' (auto)'}`;
    $('ppm').textContent = valid ? fmt(ppm,2) : '—';
    $('needppm').textContent = Number.isFinite(needPPM) ? `Needed: ${fmt(needPPM,2)} pts/min` : 'Needed: —';
    $('paceProj').textContent = Number.isFinite(paceProj) ? fmt(paceProj,1) : '—';
    $('blendProj').textContent = Number.isFinite(blendProj) ? fmt(blendProj,1) : '—';
    $('edge').textContent = Number.isFinite(edge) ? `Edge vs market: ${fmt(edge,1)} pts` : 'Edge vs market: —';

    // lean box
    let leanText = 'PASS / WAIT';
    let leanClass = 'warn';
    let why = 'Edge inside threshold.';
    if(Number.isFinite(edge) && Number.isFinite(thr)){
      if(edge >= thr){ leanText='OVER'; leanClass='good'; why='Model > market by threshold.'; }
      else if(edge <= -thr){ leanText='UNDER'; leanClass='good'; why='Model < market by threshold.'; }
    }

    const lb = $('leanBox');
    lb.classList.remove('good','warn','bad');
    lb.classList.add(leanClass);
    $('lean').textContent = leanText;
    $('why').textContent = why;

    // flags (only if filled)
    const flags = [];
    const fta = optNum('fta');
    const tpct = optNum('tpct');
    if(Number.isFinite(fta) && valid){
      const ftaPerMin = fta/elapsed;
      if(ftaPerMin >= 1.1) flags.push({t:`High FT rate (${fmt(ftaPerMin,2)}/min)`, c:'bad'});
      else if(ftaPerMin >= 0.85) flags.push({t:`FT rate elevated (${fmt(ftaPerMin,2)}/min)`, c:'warn'});
      else flags.push({t:`FT rate ok (${fmt(ftaPerMin,2)}/min)`, c:'good'});
    }
    if(Number.isFinite(tpct)){
      if(tpct >= 0.42) flags.push({t:`3P% hot (${fmt(tpct*100,1)}%)`, c:'warn'});
      else if(tpct <= 0.31) flags.push({t:`3P% cold (${fmt(tpct*100,1)}%)`, c:'warn'});
      else flags.push({t:`3P% normal (${fmt(tpct*100,1)}%)`, c:'good'});
    }

    const flagsEl = $('flags');
    flagsEl.innerHTML = '';
    if(flags.length===0){
      const d = document.createElement('div');
      d.className = 'flag';
      d.textContent = 'No extra flags.';
      flagsEl.appendChild(d);
    } else {
      flags.forEach(f=>{
        const d = document.createElement('div');
        d.className = `flag ${f.c}`;
        d.textContent = f.t;
        flagsEl.appendChild(d);
      });
    }

    hedgeCalc();
  }

  // buttons
  $('calc').addEventListener('click', compute);
  $('reset').addEventListener('click', () => location.reload());

  $('apiRefresh').addEventListener('click', async () => {
    try{
      lastApi = await apiGet('/nba/live');
      populateGames(lastApi.games);
    } catch(e){ alert("Refresh error: " + e.message); }
  });

  $('apiFillAll').addEventListener('click', async () => {
    try{
      if(!lastApi) lastApi = await apiGet('/nba/live');
      const id = $('gameSel').value;
      const g = (lastApi.games || []).find(x => x.id === id);
      if(!g) return;

      if(Number.isFinite(g.totals_consensus)) {
        $('live').value = g.totals_consensus;
        if (g.state === "pre") $('line').value = g.totals_consensus; // ✅ baseline sync
      }

      if(Number.isFinite(g.scores?.home)) $('homePts').value = g.scores.home;
      if(Number.isFinite(g.scores?.away)) $('awayPts').value = g.scores.away;

      if(g.state === "in" && Number.isFinite(g.period) && g.period >= 1 && g.displayClock && String(g.displayClock).includes(':')) {
        $('q').value = String(Math.max(1, Math.min(4, g.period)));
        $('tleft').value = g.displayClock;
      }

      compute();
    } catch(e){ alert("Fill error: " + e.message); }
  });

  $('apiStats').addEventListener('click', async () => {
    try{
      if(!lastApi) lastApi = await apiGet('/nba/live');
      const id = $('gameSel').value;
      const g = (lastApi.games || []).find(x => x.id === id);
      if(!g) return;
      if(!g.espn_event_id) return alert("No ESPN event id yet—hit Refresh again.");

      const stats = await apiGet(`/nba/stats?event=${encodeURIComponent(g.espn_event_id)}`);
      if(Number.isFinite(stats.three_pct)) $('tpct').value = stats.three_pct.toFixed(2);
      if(Number.isFinite(stats.fta_total) && stats.fta_total > 0) $('fta').value = stats.fta_total;
      compute();
    } catch(e){ alert("Stats error: " + e.message); }
  });

  // recompute on edits
  ['q','tleft','homePts','awayPts','live','line','thr','alpha','bonusBoost','bonus','ftparade','fta','tpct',
   'mySide','myLine','myStake','myOdds','hedgeLine','hedgeOdds'
  ].forEach(id => {
    $(id).addEventListener('input', compute);
    $(id).addEventListener('change', compute);
  });

  compute();
</script>
</body>
</html>

